<%@ page language="java" contentType="text/html; charset=utf-8" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<style>
td[data-toggle="dropdown"]{
	cursor: pointer;
}
/* 진료목록 헤더 */
.tableHead {
	position: sticky;
	top: -0.1px;
	background-color: whitesmoke;

}
td {
	text-align: center;
}

.ptInfo{
	vertical-align: bottom;
}

h2:after {
  content: '\00A7';
}

#uploadFile{
	float: right;
}

</style>

<div class="content-wrapper" style="background-color: #657D96; height: 900px;">
	<!-- main 검색창을 포함한 navbar 시작-->
	<nav class="navbar navbar-expand navbar-white navbar-light" style="background-color: #404b57;">

		<div class="dropdown">
			<input type="text" class="form-control" id="ptSearch" placeholder="환자 검색" onkeyup="searchPatient(this);" style="width: 400px;" />
			<ul id="ptSearchDropdown" class="dropdown-menu">
			</ul>
		</div>
		<img src="/resources/images/layout/memo_icon.png" alt="메모" id="memo" class="brand-image elevation-1" style="margin-left: 15px;">

		<ul class="navbar-nav ml-auto">

		</ul>
	</nav>
	<!-- main 검색창을 포함한 navbar 끝 -->
	<section class="content" style="margin-top: 1%;">
		<div class="row">
         <div class="col-lg-7">
            <!-------------------- 진료 기록 -------------------->
            <div class="card card-info menuDiv">
               <div class="card-header" style="background-color: #404b57;">
                  <h3 class="card-title" style="color: white;">진료 기록</h3>
               </div>

               <div class="card-body table-responsive p-0"
                  style="height: 850px; border-bottom: 20px; overflow-x: hidden;"
                  id="tabCard">
                  <div id="example2_wrapper"
                     class="dataTables_wrapper dt-bootstrap4">
                     <div class="row">
                        <div class="col-sm-12">
                           	<div class="card-body py-2 text-right" style="max-height: 45px;">
								<input type="date" id="checkUpSDate" /> ~ <input type="date" id="checkUpEDate" />
							</div>
							<!-- table-striped -->
                           <table id="table table-hover text-nowrap"
                              class="table table-bordered table-hover dataTable dtr-inline tablehover " 
                              aria-describedby="example2_info" style="table-layout: fixed;">
                              <thead class="tableHead text-center">
                                 <tr>
                                    <th style="width: 14%;">진료번호</th>
                                    <th style="width: 9%;">진료일</th>
                                    <th style="width: 7%;">이름</th>
                                    <th style="width: 10%;">차트번호</th>
                                    <th style="width: 10%;">생년월일</th>
                                    <th style="width: 7%;">담당의사</th>
                                 </tr>
                              </thead>
                              <tbody id="chartInfo">
                              <!-- 진료 정보 출력 -->
                              </tbody>
                           </table>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <!-------------------- 진료 기록 -------------------->
         </div>
         <div class="col-lg-5">
	        <!-------------------- 환자 정보 시작  -------------------->
            <div class="card card-info" style='width:auto; height:21%;'>
               <div class="card-header" style="background-color: #404b57;">
                  <h3 class="card-title" style="color: white;">환자 정보</h3>
               </div>

               <div class="card-body table-responsive p-0"
                  style="height: 850px; border-bottom: 20px; overflow-x: hidden;"
                  id="tabCard">
                  <div id="example2_wrapper"
                     class="dataTables_wrapper dt-bootstrap4">
                     <div class="row">
                        <div class="col-sm-12">
                           <!-- 환자 정보 시작 -->
                           <table class="table align-middle" id=ptInfo>
                           		<tr>
                           			<td style="width:200px;">환자이름</td>
                           			<td><div id="ptNm"></div></td>
                           		</tr>
                           		<tr>
                           			<td>차트번호</td>
                           			<td><div id="ptNum"></div></td>
                           		</tr>
                           		<tr>
                           			<td>생년월일</td>
                           			<td><div id="ptBrdt"></div></td>
                           		</tr>
                           		<tr>
                           			<td>성별</td>
                           			<td>
                           				<div class="form-check">
	                           				<input class="form-check-input" type="checkbox" name="gender" id="M" disabled>
	                           				<label class="form-check-label" for="M">&nbsp;남&nbsp;성&nbsp;</label>
											&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;          				
											<input class="form-check-input" type="checkbox" name="gender" id="F" disabled>
											<label class="form-check-label" for="F">&nbsp;여&nbsp;성&nbsp;</label>
										</div>	
                           			</td>
                           		</tr>
                           		<tr>
                           			<td colspan="2">환자 메모</td>
                           			
                           		</tr>
                           		<tr>
                           			<td colspan="2" rowspan="2" ><div id="ptMemo"></div></td>
                           		</tr>
                           </table>
<!--                            		<li><h1> 환자정보</h1></li> -->
<!--                            		<li>환자이름 : <label><div id="ptNm"></div></label></li> -->
<!--                            		<li>차트번호 : <label><div id="ptNum"></div></label></li> -->
<!--                            		<li>생년월일 : <label><div id="ptBrdt"></div></label></li> -->
<!--                            		<li> -->
<!-- 	                           		성별 -->
<!-- 									<label><input type="checkbox" name="gender" id="M" value="M" disabled>남</label>	 -->
<!-- 									<label><input type="checkbox" name="gender" id="F" value="F" disabled>여</label>	 -->
<!-- 						   		</li> -->
<!--                            </ul> -->
                           
                          	<!-- 환자 정보 끝 -->
                        </div>

                     </div>
                  </div>
               </div>
            </div>
	        
	        <!-------------------- 환자 정보 완료 -------------------->
	        <!-------------------- 썸네일 시작  -------------------->
	            <div class="card card-info" style='width:auto; height:27%;'>
	               <div class="card-header" style="background-color: #404b57;">
	                  <h3 class="card-title" style="color: white;">썸네일 정보</h3>
	                  
	                 <!-- 업로드 시작 버튼 -->
							<input type="file" class="btn btn-info btn-sm" id="uploadFile1" value="사진 업로드" multiple />
							<button type="button" class="btn btn-info btn-sm" id="uploadFile">사진 업로드</button>
	                  <!-- 업로드 시작 버튼 -->
	                  
	               </div>
	
	               <div class="card-body table-responsive p-0"
	                  style="height: 850px; border-bottom: 20px; overflow-x: hidden;"
	                  id="tabCard">
	                  <div id="example2_wrapper"
	                     class="dataTables_wrapper dt-bootstrap4">
	                     <div class="row">
	                        <div class="col-sm-12">
	                        	<div class="card-body py-2 text-right" style="max-height: 45px;">
									<input type="date" id="checkUpSDate" /> ~ <input type="date" id="checkUpEDate" />
								</div>
							</div>
							<div class="col-sm-12">
								<!-- 영상 출력 시작 -->
								<div class="card-body table-responsive p-0" style="height:auto; 
										border-bottom: 20px border:1px solid blue; overflow-x: hidden;"
										id="img-upload" >
<!-- 									<span class="border border-0"></span> -->
<!-- 									<span class="border border-top-0"></span> -->
<!-- 									<span class="border border-end-0"></span> -->
<!-- 									<span class="border border-bottom-0"></span> -->
<!-- 									<span class="border border-start-0"></span> -->
								</div>
								<!-- 영상 출력 끝 -->
	                        </div>
	                     </div>
	                  </div>
	               </div>
	            </div>
	        <!-------------------- 썸네일 완료 -------------------->
         </div>
      </div>
	</section>
</div>

<script>

// 파일 업로드
$(document).on('click', "#uploadFile", function(){
	var form = $('#uploadFile1')[0].files;
	var formData = new FormData();	
	
	[...form].forEach(function(file){
		formData.append('image', file);
	});
	
	$.ajax({
	   url:"/hospital/media/uploadFile",
	   type:"POST",
	   processData:false,
	   contentType:false,
	   data:formData,
	   beforeSend: function(xhr) {
           xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
       },
	   success:function(data){
		   console.log(data);	 
	   }
	});  	
});
// 새 창 띄우기
function newWindow(){
	var link = '';
    window.location.href = link;       //웹개발할때 숨쉬듯이 작성할 코드
    window.open(link);
}

// 이미지 업로드 시작
$(function(){
	//이미지 미리보기 시작///////////////////
	let sel_file = [];
	//<input type="file" id="input_imgs" name="uploadFile" />
	$("#uploadFile").on("change",handleImgFileSelect);
	$("#uploadFile1").on("change",handleImgFileSelect);
	//파라미터e : onchange 이벤트 객체
	function handleImgFileSelect(e){
		//이벤트가 발생된 타겟 안에 들어있는 이미지 파일들을 가져옴
		let files = e.target.files;
		//이미지가 여러개가 있을 수 있으므로 이미지들을 분리해서 배열로 만듦
		let fileArr = Array.prototype.slice.call(files);
		//파일 오브젝트의 배열 반복. f : 배열 안에 들어있는 각각의 이미지 파일 객체
		fileArr.forEach(function(f){
			//이미지 파일이 아닌 경우 이미지 미리보기 실패 처리(image/jpeg)
			if(!f.type.match("image.*")){
				alert("이미지 확장자만 가능합니다");
				//함수 종료
				return;
			}
			//이미지 객체(f)를 전역 배열타입 변수(sel_file)에 넣자
			sel_file.push(f);
			//이미지 객체를 읽을 자바스크립트의 reader 객체 생성
			let reader = new FileReader();
			//e : reader객체가 이미지 객체를 읽는 이벤트
			reader.onload = function(e){
				//e.target : 이미지 객체
				//e.target.result : reader가 이미지를 다 읽은 결과
				let img_html = "<p><img src=\"" + e.target.result + "\" class='img' /></p>";
				console.log("e.target.result : " + e.target.result);
				//div 사이에 이미지가 렌데링되어 화면에 보임
				//객체.append : 누적, .html : 새로고침, innerHTML : J/S
				$("#img-upload").append(img_html);
			}
			
// 			var ret = window.open('', parent, false );
			
			window.open("C:/Users/PC-14/Desktop/image1111.jpg");
			
			var imgsrc = e.target.result;
			
			const clickImg = (imgsrc,pageName) =>{
			    // alert(imgsrc);
			    var imageWin = new Image();
			    imageWin = window.open("", "", "width=600px, height=600px"); 
			    imageWin.document.write("<html><body style='margin:0'>"); 
			    imageWin.document.write("<img src='" + imgsrc + "' border=0>"); 
			    imageWin.document.write("</body><html>"); 
			    imageWin.document.title = pageName;
			    
			}
			
			//f : 이미지 파일 객체를 읽은 후 다음 이미지 파일(f)을 위해 초기화 함
			reader.readAsDataURL(f);
		});//end forEach
	}
	//이미지 미리보기 끝///////////////////
});

$(document).on('click','.img', function(){
	var img = document.getElementsByTagName("img");
	for (var x = 0; x < img.length; x++) {
	  img.item(x).onclick=function() {window.open(this.src)}; 
	}
});


// 이미지 업로드 시작




// 오늘 날짜와 한달 전 날짜 입력
var edate = new Date();
$("#checkUpEDate").val(formatDate(edate));
var sdate = edate.setMonth(edate.getMonth() - 1);
$("#checkUpSDate").val(formatDate(sdate));

// 날짜 변경 시
$(document).on('change', 'input[type="date"]', function(){
	$("#chartInfo").html("");
	var ptNm = $("#ptNm").text();
	var ptNum = $("#ptNum").text();
	if(ptNm == '' || ptNm == null){
		return;
	}
	if(ptNum == '' || ptNum == null){
		return;
	}
	edate = $("#checkUpEDate").val();
	sdate = $("#checkUpSDate").val();
	data = {
		'ptNum':ptNum,
		'ptNm':ptNm,
		'sdate':sdate,
		'edate':edate	
	}
	checkUpInfo(data);
});

// 이름 받기
function selectPt(pt){
	console.log('클릭함 : ' + pt.innerText);
	var ptInfo = pt.innerText.split('(');
	var ptNm = ptInfo[0]
	var ptNum = ptInfo[1].substr(0,9);
	edate = $("#checkUpEDate").val();
	sdate = $("#checkUpSDate").val();
	var data = {
		'ptNum':ptNum,
		'ptNm':ptNm,
		'sdate':sdate,
		'edate':edate
	}
	checkUpInfo(data);
	$("#ptSearch").val(pt.innerText);
}

function checkUpInfo(data){

	$.ajax({
		url:'/hospital/media/ptInfo',
		type:'post',
		data:JSON.stringify(data),
		dataType:'json',
		beforeSend: function(xhr) {
           xhr.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
           xhr.setRequestHeader('${_csrf.headerName}', '${_csrf.token}');
        },
		success: function(res){
			console.log('환자 정보 불러오기 성공 : ' + JSON.stringify(res));
			var brdt = res.ptBrdt.trim();
			var brday = brdt.substr(0,4) + "." + brdt.substr(4,2) + "." + brdt.substr(6);
			
			$("#ptNm").text(res.ptNm);
			$("#ptNum").text(res.ptNum);
			$("#ptBrdt").text(brday);
			$("#ptMemo").text(res.ptMemo);
			$("input[id='" + res.ptGen + "']").prop('checked',true);
			
			var chartUpInfo = '';
			$.each(res.chkList, function(i, v){
				chartUpInfo += "<tr id=" + v.chkNum + ">";
				chartUpInfo += "	<td style='width: 14%;'>" + v.chkNum + "</td>";
				chartUpInfo += "	<td style='width: 9%;'>" + formatDate(v.chkDt) + "</td>"
				chartUpInfo += "	<td style='width: 7%;'>" + res.ptNm + "</td>"
				chartUpInfo += "	<td style='width: 10%;'>" + res.ptNum + "</td>"
				chartUpInfo += "	<td style='width: 10%;'>" + brday + "</td>"
				chartUpInfo += "	<td style='width: 7%;'>" + v.empNm + "</td>"
				chartUpInfo += "</tr>"
			});
			$('#chartInfo').html(chartUpInfo);
		}
	});
}


$(document).on('click', 'tr', function(){
	console.log(this.id);
})

function formatDate(date) {
    var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear();

    if (month.length < 2) 
        month = '0' + month;
    if (day.length < 2) 
        day = '0' + day;

    return [year, month, day].join('-');
}

// 환자 상세정보의 탭을 클릭하여 탭 내용을 바꾼다.
$('#ptDetailTabList a').on('click', function(){
	$(this).tab('show');
});

// 환자 검색란에 값 입력 시 드롭박스 메뉴가 열린다.
$('#famPtSearch').on('keyup', function(e){
	$(this).dropdown('toggle');
});

// 환자 검색란을 떠나면 드롭박스 메뉴가 닫힌다.
$('#famPtSearch').on('blur', function(e){
	if($('#famPtSearchDropdown').hasClass('show')){
		$('#famPtSearchDropdown').removeClass('show');
	}
});

</script>
<script src="/resources/js/searchModule.js"></script>
<script src="/resources/js/alertModule.js"></script>
<!-- <script src="/resources/js/deskPatient.js"></script> -->
<!-- <script src="/resources/js/deskRegist.js"></script> -->	
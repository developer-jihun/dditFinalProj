<%@ page language="java" contentType="text/html; charset=UTF-8" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<style>
.overflow-auto::-webkit-scrollbar{
	width: 8px;
	height: 8px;
}
.overflow-auto::-webkit-scrollbar-thumb{
    background-color: #404b57;
    border-radius: 5px;
}
.overflow-auto::-webkit-scrollbar-track{
    background-color: rgba(0,0,0,0);
}
.rcvmtMenu a{
	font-family: 'Noto Sans KR', sans-serif;
	color: white;
}
.waitingRcvmtRow, .completedRcvmtRow{
	cursor: pointer;
}
#receiptForm label{
	margin: 0px;
	display: flex;
	justify-content: center;
	align-items: center;
}
#receiptForm input{
	text-align: right;
}
</style>
<div class="content-wrapper" style="background-color: #657D96;">
	<!-- main 검색창을 포함한 navbar 시작-->
	<nav class="navbar navbar-expand navbar-white navbar-light" style="background-color: #404b57;">
		<div class="input-group" style="width: 400px;">
			<input type="text" class="form-control" id="ptSearch" placeholder="환자 검색">
			<div class="input-group-append">
				<button type="button" id="ptSearchBtn" class="btn btn-outline-secondary" onclick="searchPtOnCrmList();">검색</button>
			</div>
		</div>
		<img src="/resources/images/layout/memo_icon.png" alt="메모" id="memo" class="brand-image elevation-1" style="margin-left: 15px;">
		<ul class="navbar-nav ml-auto"></ul>
		<div class="rcvmtMenu d-flex justify-content-around" style="min-width: 280px;">
			<a href="#" onclick="changeMenu('rcvmtMain');">수납</a>
			<a href="#" onclick="changeMenu('rcvmtList');">수납 내역</a>
			<a href="#" onclick="changeMenu('paymentList');">결제 내역</a>
		</div>
	</nav>
	
	<section class="content" style="margin-top: 1%; height: 900px;">
	
		<!-- 수납대기/완료 목록 시작 -->
		<div class="row mb-3" style="height: 40%;">
			<!-- 수납대기 시작 -->
			<div class="col-md-6">
				<div class="card card-info" style="height: 100%;">
					<div class="card-header" style="background-color: #404b57;">
						<div class="card-title">
							<h5 class="m-0">수납대기</h5>
						</div>
					</div>
					<div class="card-body p-0">
						<table class="table table-hover text-center">
							<thead class="sticky-top bg-white">
								<tr>
									<th>차트번호</th>
									<th>이름</th>
									<th>진료의사</th>
									<th>진료비</th>
								</tr>
							</thead>
							<tbody id="watingRcvmtListBody">
							</tbody>
						</table>
					</div>
				</div>
			</div>
			<!-- 수납대기 끝  -->
			<!-- 수납완료 시작  -->
			<div class="col-md-6">
				<div class="card card-info" style="height: 100%;">
					<div class="card-header" style="background-color: #404b57;">
						<div class="card-title">
							<h5 class="m-0">수납완료</h5>
						</div>
					</div>
					<div class="card-body p-0">
						<table class="table table-hover text-center">
							<thead class="sticky-top bg-white">
								<tr>
									<th>차트번호</th>
									<th>이름</th>
									<th>결제금액</th>
								</tr>
							</thead>
							<tbody id="completedRcvmtListBody">
							</tbody>
						</table>
					</div>
				</div>
			</div>
			<!-- 수납완료 끝  -->
		</div>
		<!-- 수납대기/완료 목록 끝 -->
		
		<!-- 환자정보 시작 -->
		<div class="card card-info" style="height: 28%;">
			<div class="card-header" style="background-color: #404b57;">
				<div class="card-title">
					<h5 class="m-0">환자정보 : <span id="ptHistListPtNm"></span></h5>
				</div>
			</div>
			<div class="card-body p-0">
				<div class="row h-100">
					<div class="col-md-2 h-100">
						<table class="table text-center p-0 m-0" style="height: 100%;">
							<tr>
								<td class="p-0">
									<a href="#"
									   class="ptHistType dropdown-item"
									   onclick="changePtHistType(this, 'ptRcvmtHistList');">수납</a>
								</td>
							</tr>
							<tr class="border-right">
								<td class="p-0">
									<a href="#"
									   class="ptHistType dropdown-item"
									   onclick="changePtHistType(this, 'ptChkupHistList');">진료</a>
								</td>
							</tr>
							<tr class="border" style="height: 100%;">
							</tr>
						</table>
					</div>
					<div class="col-md-10" style="height: 100%;">
						<div id="ptRcvmtHistList" class="overflow-auto ptHistList" style="height: 100%;">
							<table class="table text-center">
								<thead class="sticky-top bg-white">
									<tr>
										<th>번호</th>
										<th>총금액</th>
										<th>잔여금액</th>
										<th>수납일시</th>
									</tr>
								</thead>
								<tbody id="ptRcvmtHistListBody"></tbody>
							</table>
						</div>
						<div id="ptChkupHistList" class="overflow-auto ptHistList d-none" style="height: 100%;">
							<table class="table text-center">
								<thead class="sticky-top bg-white">
									<tr>
										<th>진료번호</th>
										<th>진료일</th>
										<th>담당의사</th>
									</tr>
								</thead>
								<tbody id="ptChkupHistListBody"></tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- 환자정보 끝 -->
		
		<!-- 결제정보 시작 -->
		<div class="card card-info" style="height: 22%;">
			<div class="navbar card-header" style="background-color: #404b57;">
				<div class="card-title">
					<h5 class="m-0">결제정보</h5>
				</div>
				<ul class="navbar-nav ml-auto"></ul>
				<div class="text-right">
					<button class="btn btn-primary" onclick="" style="background-color: #904aff; border: #904aff;">카드 결제</button>
					<button class="btn btn-success" onclick="payInCash();">현금 결제</button>
				</div>
			</div>
			<div class="card-body py-3">
				<form id="receiptForm" name="receiptForm">
					<div class="row">
						<div class="col-sm-4">
							<div class="form-group row my-2">
								<label class="col-sm-4">수납번호</label>
								<input type="text" class="col-sm-8 form-control-plaintext" name="rcvmtNum" readonly />
							</div>
							<div class="form-group row my-2">
								<label class="col-sm-4">상태</label>
								<input type="text" class="col-sm-8 form-control-plaintext" name="rcvmtStatus" readonly />
							</div>
						</div>
						<div class="col-sm-4">
							<div class="form-group row my-2">
								<label class="col-sm-3">진료비</label>
								<input type="text" id="rcvmtAmt" class="col-sm-7 form-control-plaintext" name="rcvmtAmt" readonly />
								<h3 class="col-sm-2 text-right">원</h3>
							</div>
							<div class="form-group row my-2">
								<label class="col-sm-3">할인</label>
								<input type="text" id="rcvmtDscntAmt" class="col-sm-7 form-control" name="rcvmtDscntAmt" />
								<h3 class="col-sm-2 text-right">원</h3>
							</div>
						</div>
						<div class="col-sm-4">
							<div class="form-group row my-2">
								<label class="col-sm-3">합계</label>
								<input type="text" id="rcvmtGramt" class="col-sm-7 form-control-plaintext" name="rcvmtGramt" readonly />
								<h3 class="col-sm-2 text-right">원</h3>
							</div>
							<div class="form-group row my-2">
								<label class="col-sm-3">결제금액</label>
								<input type="text" id="rctAmt" class="col-sm-7 form-control" name="rctAmt" />
								<h3 class="col-sm-2 text-right">원</h3>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
		<!-- 결제정보 끝 -->
		
	</section>
</div>
<script>

listWaitingRcvmt();
listCompletedRcvmt();

// 수납대기 행을 클릭하면 해당 환자의 이력정보와 수납에 필요한 정보를 가져옴
$(document).on('click', '.waitingRcvmtRow', function(){
	
	const ptNum = $(this).find('.waitingRcvmtPtNum').text().trim();
	const ptNm = $(this).children()[1].textContent.trim();
	
	$('#ptHistListPtNm').text(ptNm + '(' + ptNum + ')');
	
	const rcvmtNum = $(this).data('rcvmtnum');
	selectRcvmt(rcvmtNum);
	
	listPtRcvmtHist(ptNum);
	listPtChkupHist(ptNum);
	
});

$('#rcvmtDscntAmt').on('blur', function(){
	
	let rcvmtDscntAmt = $(this).val();
	let rcvmtAmt = $('#rcvmtAmt').val()
	if(rcvmtAmt == '') return false;
	
	rcvmtAmt = rcvmtAmt.replace(/\,/g, '');
	
	let newRcvmtGramt = rcvmtAmt - rcvmtDscntAmt;
	
	$('#rcvmtGramt').val(newRcvmtGramt.toLocaleString());
	
});

// 수납대기 목록 조회
function listWaitingRcvmt(){
	
	fetch('/hospital/rcvmt/listWaitingRcvmt')
	.then(res => res.json())
	.then(watingRcvmtList => {
		
		let code = '';
		watingRcvmtList.forEach(function(rcvmt){
			
			code += '<tr class="waitingRcvmtRow" data-rcvmtnum="' + rcvmt.rcvmtNum + '">';
			code += '<td class="waitingRcvmtPtNum">' + rcvmt.ptNum + '</td>';
			code += '<td>' + rcvmt.ptNm + '</td>';
			code += '<td>' + rcvmt.empNm + '</td>';
			code += '<td>' + rcvmt.rcvmtAmt.toLocaleString() + '</td>';
			code += '</tr>';
			
		});
		
		document.querySelector('#watingRcvmtListBody').innerHTML = code;
	});
	
}

//수납완료 목록 조회
function listCompletedRcvmt(){
	
	fetch('/hospital/rcvmt/listCompletedRcvmt')
	.then(res => res.json())
	.then(completedRcvmtList => {
		
		let code = '';
		completedRcvmtList.forEach(function(rcvmt){
			
			code += '<tr class="completedRcvmtRow" data-rcvmtnum="' + rcvmt.rcvmtNum + '">';
			code += '<td>' + rcvmt.ptNum + '</td>';
			code += '<td>' + rcvmt.ptNm + '</td>';
			code += '<td>' + rcvmt.rcvmtAmt.toLocaleString() + '</td>';
			code += '</tr>';
			
		});
		
		document.querySelector('#completedRcvmtListBody').innerHTML = code;
	});
	
}

// 수납정보 조회
function selectRcvmt(rcvmtNum){
	
	fetch('/hospital/rcvmt/selectRcvmt?rcvmtNum=' + rcvmtNum)
		.then(res => res.json())
		.then(rcvmt => {
			
			let receiptForm = document.receiptForm;
			receiptForm.rcvmtNum.value = rcvmt.rcvmtNum;
			receiptForm.rcvmtAmt.value = rcvmt.rcvmtAmt.toLocaleString();
			receiptForm.rcvmtStatus.value = rcvmt.rcvmtStatus;
			receiptForm.rcvmtDscntAmt.value = rcvmt.rcvmtDscntAmt;
			receiptForm.rcvmtGramt.value = rcvmt.rcvmtGramt.toLocaleString();
			
		});
}

// 환자정보 메뉴 변경
function changePtHistType(element, type){
	
	document.querySelectorAll('.ptHistType').forEach(function(type){
		type.blur();
		type.parentNode.parentNode.classList.add('border-right');
	});
	
	element.parentNode.parentNode.classList.remove('border-right');
	
	document.querySelectorAll('.ptHistList').forEach(function(list){
		list.classList.add('d-none');
	});
	
	document.querySelector('#' + type).classList.remove('d-none');
	
}

// 환자 수납이력 조회
function listPtRcvmtHist(ptNum){
	
	fetch('/hospital/rcvmt/listPtRcvmtHist?ptNum=' + ptNum)
		.then(res => res.json())
		.then(rcvmtList => {
			
			let code = '';
			rcvmtList.forEach(function(rcvmt){
				code += '<tr>';
				code += '<td>' + rcvmt.rcvmtNum + '</td>';
				code += '<td>' + rcvmt.rcvmtGramt.toLocaleString() + '</td>';
				code += '<td>' + rcvmt.rcvmtBalance.toLocaleString() + '</td>';
				code += '<td>' + rcvmt.rcvmtDtStr + '</td>';
				code += '</tr>';
			});
			
			document.querySelector('#ptRcvmtHistListBody').innerHTML = code;
			
		});
	
}

// 환자 진료이력 조회
function listPtChkupHist(ptNum){
	
	fetch('/hospital/rcvmt/listPtChkupHist?ptNum=' + ptNum)
	.then(res => res.json())
	.then(chkupList => {
		
		let code = '';
		chkupList.forEach(function(chkup){
			code += '<tr>';
			code += '<td>' + chkup.chkNum + '</td>';
			code += '<td>' + chkup.chkDtStr + '</td>';
			code += '<td>' + chkup.ptNm + '</td>';
			code += '</tr>';
		});
		
		document.querySelector('#ptChkupHistListBody').innerHTML = code;
		
	});
	
}

// 현금 결제
function payInCash(){
	
	const rctAmt = document.querySelector('#rctAmt').value.trim();
	if(rctAmt == '') {
		simpleErrorAlert('결제금액을 확인해주세요.');
		return false;
	}
	
	Swal.fire({
		title: '결제 방식 확인',
		text: '현금 결제 후 수납완료 처리하시겠습니까?',
		showDenyButton: true,
		confirmButtonText: '확인',
		denyButtonText: '취소',
	}).then(result => {
		if(result.isConfirmed){
			
			const rcvmtNum = document.receiptForm.rcvmtNum.value;
			const rcvmtDscntAmt = document.receiptForm.rcvmtDscntAmt.value;
			const rctAmt = document.receiptForm.rctAmt.value.replace(/\,/g, '');
			
			const csrfToken = $('#_csrfToken').val();
			fetch('/hospital/rcvmt/payInCash', {
				method: 'post',
				headers: {
					'X-CSRF-TOKEN' : csrfToken,
					'Content-Type' : 'application/json;charset=utf-8'
				},
				body: JSON.stringify({
					'rcvmtNum' : rcvmtNum,
					'rcvmtDscntAmt' : rcvmtDscntAmt,
					'rctAmt' : rctAmt,
					'rctPayOpt' : 'CASH',
					'rctType' : 'RCVMT'
				})
			})
				.then(res => res.text())
				.then(text => {
					
					if(text == 'FAILED'){
						simpleJustErrorAlert();
						return false;
					}
					
					listWaitingRcvmt();
					listCompletedRcvmt();
					document.querySelector('#ptHistListPtNm').textContent = '';
					document.querySelector('#ptRcvmtHistListBody').innerHTML = '';
					document.querySelector('#ptChkupHistListBody').innerHTML = '';
					document.receiptForm.reset();
					
					simpleSuccessAlert('결제가 완료되었습니다.');
				});
		}
	});
	
}

</script>
<script src="/resources/js/alertModule.js"></script>
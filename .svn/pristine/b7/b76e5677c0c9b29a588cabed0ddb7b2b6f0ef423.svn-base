<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.web.ddentist.mapper.PreservationMapper">
	
	<select id="selectPtNum" parameterType="ptVO" resultType="String">
		SELECT PT_NUM
		  FROM PATIENT
		 WHERE PT_NM = #{ptNm}
		   AND PT_RRNO = #{ptRrno}
	</select>
	
	<select id="listPresv" parameterType="String" resultType="reservationVO">
		SELECT R.RESV_NUM, R.RESV_CC,
			   TO_CHAR(R.RESV_SDT, 'YYYY.MM.DD HH24:MI') RESV_SDT,
			   (SELECT COMM_CD_CNT
			      FROM COMMON_CODE
			     WHERE COMM_CD_NM = R.RESV_STATUS) RESV_STATUS
		  FROM RESERVATION R
		 WHERE R.PT_NUM = #{ptNum}
		 ORDER BY R.RESV_NUM DESC
	</select>
	
	<select id="listNonPresv" parameterType="ptVO" resultType="reservationVO">
		SELECT R.RESV_NUM, R.RESV_CC,
			   TO_CHAR(RESV_SDT, 'YYYY.MM.DD HH24:MI') RESV_SDT,
			   (SELECT COMM_CD_CNT
			      FROM COMMON_CODE
			     WHERE COMM_CD_NM = R.RESV_STATUS) RESV_STATUS
		  FROM RESERVATION R
		 WHERE R.PT_NM = #{ptNm}
		   AND R.PT_PHONE = #{ptPhone}
		   AND R.PT_NUM LIKE 'T' || '%'
		 ORDER BY R.RESV_NUM DESC
	</select>
	
	<select id="selectPresv" parameterType="String" resultType="reservationVO">
		SELECT R.RESV_NUM, R.PT_NUM, R.EMP_NUM, R.PT_NM, R.RESV_CC,
			   TO_CHAR(R.RESV_SDT, 'YYYY.MM.DD HH24:MI') RESV_SDT,
			   (SELECT COMM_CD_CNT
			      FROM COMMON_CODE
			     WHERE COMM_CD_NM = R.RESV_STATUS) RESV_STATUS,
			   E.EMP_NM, E.EMP_IMG,
			   (SELECT DEPT_NM
			   	  FROM DEPARTMENT
			   	 WHERE DEPT_CD = E.DEPT_CD) DEPT_NM
		  FROM RESERVATION R INNER JOIN EMPLOYEE E ON (R.EMP_NUM = E.EMP_NUM)
		 WHERE R.RESV_NUM = #{resvNum}
	</select>
	
	<update id="cancelResv" parameterType="reservationVO">
		UPDATE RESERVATION SET RESV_STATUS = 'CANCEL_RESV'
						 WHERE RESV_NUM = #{resvNum}
	</update>
	
</mapper>